---
layout: post
title: 서버 성능 개선
category: Architecture
---

생각나는대로, 듣는대로 막 정리...

## Forward Proxy vs Reverse Proxy
FP = Client side,
RP = Server side

### FP, 왜 필요한가?
- 캐시를 사용할 수 있다.
- 서버로 가지 않고도 클라이언트 쪽에서 바로 줄 수 있는 자원.
- 회사에서 사내 IP를 쓰고 있는 경우, 매번 원격 서버에 자원을 요청할 때 매번 반복적으로 요청을 보내기보다, 프록시에서 캐싱한 자원을 돌려주는 것 등을 말함. 
- 보완적으로도 추가적 처리를 할 수 있는 것에 이점이 있음.

### RP는?
- 서버측 제일 앞 단에서 성능/보안을 위해 매번 뒤에있는 웹서버에게 위임하는 것이 아니라, 캐싱한 자원을 돌려줌.
- 서버측 앞단에서 DDOS 같은 공격을 방지. 뒤에 있는 웹서버는 방지책이 필요 없음.
- 백앤드의 공통적 부분을 Reverse Proxy가 담당. (역할 분담)


## Database
### Master - Slave
- 장애가 났을 경우에 어떻게 빠른 시간 내에 복구할 수 있느냐에 대한 전략.
- master-slave 구조는 데이터 베이스 설정 가능. 
- 어떤 간격으로 데이터 복제를 할 것이냐에 대한 설정을 해야한다.
- failover

데이터를 쓰는 것보다 읽는게 많는 서비스일 경우, 

- write/update를 하나의 DB에만 수행하게 하고, 복제 DB에는 read만 시키는 방법으로 구성할 수도 있다. 
- 이렇게 분산기켜 놓으면 글쓰기 등은 안되지만 조회는 가능하게 할 수 있도록 구성 (vice versa).

### Sharding
- 하나의 DB에 너무 많은 데이터를 가지고 있으면 쿼리할 때 성능이 떨어질 수 있다.
- 같은 DB 스키마를 가진 DB를 여러대로 나눠서 데이터를 관리 (복제 아님).
- 보통 2^n 개의 sharding을 하는데 이유는 이만큼의 수로 나눠서 나머지를 구한 경우로 어느 DB로 가야하는지 패턴을 정할 수 있다 (DB 커넥션 분기처리).
- 공통된 데이터는 common DB를 사용해서 저장할 수 있다.
- Sharding의 문제점: 균등 분할이 보장되지 않는다. -> 하나의 DB에 부하가 날 수 있다.
	- 중고나라 카페 데이터가 있는 DB만 엄청난 부하
	- 그래서 추가적으로 if문 처리를 해서 중고나라면 딴데로 가게 하기도 ㅋㅋㅋ

대용량 서비스 - 페이스북이나 구글은 RDB + sharding 대신에 분산 DB(NoSQL)를 사용.

- 오픈소스에 나와있는 DB를 자신의 서비스에 맞는 DB를 개발.

## Caching

- WAS에 캐싱할 때는 JVM에 memory를 확보해서 DB에 쿼리를 날리는게 아니라 메모리에 있는 데이터를 바로 응답 - Local Cache
	- WAS가 여러대일 경우, 중복 캐싱이 발생.
	- JVM의 캐싱 메모리 때문에 성능 저하가 발생할 수 있음.
	- RDB는 데이터를 캐싱하기에 좋은 구조가 아님. 
	- 해결: 캐시 서버 (Key-Value 형태로 저장되어있는 형태 - 캐시 용 DB)  ~1ms 걸림. - Memchached, Redis
		- 스프링도 이런 기능을 제공 - @Cacheable (AOP)


- WS는 자주 바뀌지 않는 웹 자원 - image나 js 파일 등을 캐싱.

***캐시 전략을 새울 때 중요한 것은 데이터가 얼마나 많이 hit 되는가. 무조건 얼마나 자주 안바뀌는가가 아님.***

## Load Balancing - L4 vs L7 vs HAProxy

- 하드웨어: L4와 L7의 차이 (거의 다룰일 없겠지만)- L7은 어플리케이션 레이어까지 분석이 가능하기 때문에 쿠키정보/payload를 분석할 수 있다. 따라서 Sticky Session은 L4와 L7 중 L7만 가능.
- 소프트웨어: HAProxy는 조금 더 느리지만 sticky session 구현 가능.

## Message Queue
앞단에 톰캣서버가 여러대라고 가정하고, 반드시 요청과 동시에 응답이 와야하는 요청들이 아니면 (eg. 이메일) 비동기처리를 하고 싶을 때 큐를 사용한다. 여러 WAS에서 비동기처리를 하느냐 아니면 MQ에 위임하느냐의 문제이다.

- 중앙 집중적으로 몰아넣고 싶을 때 MQ를 사용.
- 비동기로 처리할 수 있는 서비스들은 다 MQ를 사용할 수 있다.
- 하나의 MQ서버에서 서비스마다 따로 큐를 사용.
- Ex. Kafka(?), RabbitMQ 등등.