---
layout: post
title: Linux(OS) 기본 지식
category: Linux
tags: Linux Daemon Process Crontab
---

AWS 서버에 자바 어플리케이션 배포 과정을 경험해보면서 배운 리눅스 기본 지식을 정리해보았다.

#### Kernel (알맹이)

- kernel은 컴퓨터 자원을 제어하는 소프트웨어.
- cpu, 메모리, gpu 등 shell에서 요청하는 작업들을 수행하기 위한 자원을 제어한다.

#### Shell

- 어플리케이션이나 사용자가 필요한 작업을 수행하라고 명령을 내릴 수 있는 커널과 사용 엔티티 개체간의 인터페이스.
- `ls`, `cd`와 같은 명령어를 CLI에서 적고 엔터를 치면 이 명령어를 해석해서 kernel에게 필요한 작업을 수행하게 하거나 kernel로부터 정보를 읽어들여서 CLI에 결과를 반환해준다.
- 우리가 작성하는 프로그램도 shell을 통해 해석되고 kernel에게 전달되어서 필요한 작업(메모리 할당, 데이터 읽기 등)을 수행한다.

#### Process & Daemon

- 프로세스란 짦게는 실행 중인 프로그램이다. 프로그램은 단순히 컴퓨터 내에 물리적으로 존재하는 코드의 묶음을 말한다. 프로그램을 실행하게 되면 그제서야 프로그램은 필요한 컴퓨터 자원을 쓴다. 이렇게 살아있는 프로그램이 컴퓨터 자원을 쓰는 것을 프로세스라고 한다.
- CPU 하나 당 하나의 프로세스만 실행될 수 있다. CPU가 몇 개 없는데도 여러 프로세스가 실행되는 것 처럼 보이는 이유는 CPU가 여러 프로세스를 빠르게 바꿔가며 실행하기 때문이다.


- 프로스세는 또 하나의 (자식)프로세스를 만들 수 있다.
- Linux에서는 컴퓨터가 처음 부팅 될때 `systemd`라는 프로세스가 제일 먼저 생기고, 자식 프로세스로 여러 daemon 프로세스들이 시작된다.
  - daemon이란, 백그라운드 프로세스이며 컴퓨터가 꺼지거나 명시적으로 멈추라고 명령이 내려질 때까지 실행되는 프로세스이다.
  - 컴퓨터 컴퓨터가 지속적으로 혹은 정기적으로 수행해야 하는 작업을 위해 백그라운드에서 실행되는 프로세스.
  - Linux에서는 `/etc/init.d/`에 daemon 프로그램들이 있다.
  - `/etc/rc3.d/`(혹은 rc5.d) 안에 있는 심볼릭 링크 파일들은 init.d에 있는 몇 가지의 daemon프로그램을 가르키고 있는데, 이 프로그램들은 컴퓨터가 부팅 될때 시작된다.

Linux terminal에서 pstree 명령어를 치면:
![pstree로 살펴보는 프로세스](/assets/img/pstree.png)

위 그림에서 `pstree` 명령이 bash 프로세스의 자식 프로세스로 생성된 것을 볼 수 있다. bash 앞에 sshd 프로세스들은 아마 내가 ssh로 AWS에 있는 서버에 접속을 한 것 때문일 것이라 생각된다.

이 과정 중에 제일 삽질(?)을 많이 했던 부분은 환경변수 설정이었다. 자동 배포를 위해 cron(위 그림의 cron 프로세스)을 사용해서 몇 분마다 github 저장소에 업데이트가 있었는지를 확인하고 executable jar 파일을 실행하는 bash script를 실행하도록 했다. 하지만 이 스크립트를 수동으로 ./script 실행을 하면 분명 아무 문제 없이 실행이 되었지만 cron이 실행하면 java경로를 못찾았다는 에러가 났다. 환경변수 `$PATH`에 JDK의 경로를 추가하고 `export`명령어를 통해 모든 자식 프로세스들이 이 환경변수를 가지게 했는데 왜 그런가 계속 연구를 하다가 결국 프로세스 문제라는 결론에 도달했다.

위의 그림 처럼 `cron`과 `bash`는 각각 다른 프로세스이다. cron은 각각의 프로세스는 서로 다른 memory context를 가지고 있기 때문에 bash에서 환경변수를 설정했어도 해당 프로세스와 자식 프로세스에 한해서만 이 환경변수가 적용이 되는 것이다. 따라서 `crontab` 파일에다 따로 `PATH`환경변수를 지정해 줘야 프로그램이 제대로 작동한 것이다 (추가적으로 어떤 shell을 사용할지도 지정해주었다 ie.`SHELL=/bin/bash`).
